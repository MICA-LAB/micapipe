.. _microstructproc:

.. title:: MPC

Microstructural profile covariance
============================================================

This module samples intracortical intensities from a microstructurally-sensitive contrast provided as an input volume. This is achieved by constructing a series of equivolumetric surfaces between pial and white matter boundaries, yielding unique intracortical intensity profiles at each vertex of the native surface mesh. This approach has been previously applied in the `whole cortex <https://journals.plos.org/plosbiology/article?id=10.1371/journal.pbio.3000284>`_, as well as in targeted structures such as the `insula <https://www.sciencedirect.com/science/article/pii/S1053811920303451>`_. By parcellating and cross-correlating nodal intensity profiles, this module profiles microstructural profile covariance (MPC) matrices describing similiarity in intracortical microstructure across the cortex.

Intracortical equivolumetric surfaces are generated using scripts from the `surface tools repository <https://github.com/kwagstyl/surface_tools>`_, available via GitHub.


-MPC
--------------------------------------------------------

.. admonition:: Prerequisites üñêüèº

    You need to run **proc_structural**, **proc_freesurfer**, and **post_structural** before this stage

.. tabs::

    .. tab:: Processing steps

        - Compute boundary-based registration from microstructural imaging volume to FreeSurfer native space
        - Generate 16 equivolumetric surfaces between pial and white matter boundary previously defined from FreeSurfer. Surfaces closest to pial and white matter boundaries are then discarded to account for partial volume effects
        - Perform surface-based registration to fsaverage5 and conte69-32k templates
        - Average intensity profiles within parcels defined on the native FreeSurfer surface, while excluding outlier vertices
        - Perform partial correlation, controlling for parcel-wide mean profile, across all pairs of intensity profiles

    .. tab:: Usage

        .. parsed-literal:: 
            $ mica-pipe **-sub** <subject_id> **-out** <outputDirectory> **-bids** <BIDS-directory> **-MPC** <options>

        Docker command:

        .. parsed-literal:: 
            $ docker -MPC

        Singularity command: 

        .. parsed-literal:: 
            $ singularity -MPC

        Options:

        - ``-microstructural_img <path>`` specifies an input image on which to sample intensities for the MPC analysis. You must specify this flag if your dataset does not include a qT1 image, or if your microstructurally-sensitive imaging contrast is not stored in the ``rawdata``¬†branch of the BIDS directory (for example, T1-weighted divided by T2-weighted derivative file).
        - ``-microstructural_lta <path>`` lets the user specify their own registration file to map the input image to native freesurfer space. The registration file must be in ``.lta`` format. If omitted, the registration will be performed in the script using `bbregister <https://surfer.nmr.mgh.harvard.edu/fswiki/bbregister/>`_. This option may be useful if registrations need to be optimized for specific subjects or datasets.

    .. tab:: Outputs

        Directories created or populated by **-MPC**:

        .. parsed-literal:: 

            - <outputDirectory>/micapipe/anat/surfaces/micro_profiles
            - <outputDirectory>/micapipe/anat
            - <outputDirectory>/micapipe/xfms

        Files generated by **-MPC**:

        .. parsed-literal:: 
            - Microstructural image in native FreeSurfer space: *<outputDirectory>/micapipe/anat/<sub>_micro2fsspace.nii.gz*
            - Boundary-based registration outputs to register microstructural image to native FreeSurfer space: *<outputDirectory>/micapipe/xfms/<sub>_micro2fs**
            - Equivolumetric surface sampling ouputs stored in *<outputDirectory>/micapipe/anat/surfaces/micro_profiles*:
                - Native FreeSurfer space intensity at depth #: *<hemi>.<#>.mgh*
                - fsaverage5 template space intensity at depth #: *<hemi>.<#>_fsa5.mgh*
                - conte69 template space intensity at depth #: *<hemi>.<#>_c69-32k.mgh*
                - Parcellated intensity profiles: *sub-<sub>_ses-01_space-fsnative_atlas-<atlas>_desc-intensityProfiles.txt*
                - MPC matrices: *sub-<sub>_ses-01_space-fsnative_atlas-<atlas>_desc-mpc.txt*

    .. tab:: -slim        

        Files conserved during **-MPC** slim run

        .. parsed-literal:: 
            - ...
            
