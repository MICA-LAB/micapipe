.. _dwiproc:

.. title:: DWI

Diffusion-weighted imaging processing
============================================================

This section describes all DWI-related pre-processing steps. This includes image processing in preparation for the construction of tractography-based structural connectivity matrices, as well as associated edge length matrices. This processing pipeline has been optimized for multi-shell DWI, but can also handle single-shell data.


-proc_dwi
--------------------------------------------------------

This module performs required pre-processing of DWI scans, in addition to deriving useful metrics from diffusion images (e.g. fractional anisotropy, mean diffusivity). For multi-shell data, the Dhollander algorithm is applied to estimate response functions of CSF, gray, and white matter, and multi-shell, multi-tissue constrained spherical deconvolution is used to estimate fibre orientation distributions. For single-shell data, the Tournier algorithm and single-shell, single tissue constrained spherical deconvolution are used for these processing steps, respectively.

.. admonition:: Prerequisites üñêüèº

    You need to run **proc_structural** before this stage

.. tabs::

    .. tab:: Processing steps
    
        - All DWI scans found in the bids directory are aligned using a rigid-body registration, and concatenated.
        - Concatenated DWI images undergo denoising and bias field correction. Residuals are also calculated from denoised images
        - Correction of eddy current-induced distortions and motion
        - b0 image is linearly registered to the structural image (nativepro)
        - DWI brain mask is generated by registering MNI152 brain mask to DWI space using previously generated non-linear and linear transformations
        - Compute fractional anisotropy and mean diffusivity images
        - Estimate response functions of CSF, gray, and white matter for spherical deconvolution 
        - Estimate fibre orientation distributions using spherical deconvolution
        - Compute non-linear transformation from DWI (using white matter fibre orientation distribution image) and structural image aligned to the b0 scan
        - Apply inverse non-linear transformation to 5-tissue-type images for anatomically-constrained tractography
        - Compute track density image with 1 million streamlines using the iFOD1 algorithm. This image is mainly generated for quality control of previous DWI pre-processing.

    .. tab:: Usage

        .. parsed-literal:: 
            $ mica-pipe **-sub** <subject_id> **-out** <outputDirectory> **-bids** <BIDS-directory> **-proc_dwi**

        Docker command:

        .. parsed-literal:: 
            $ docker -proc_dwi

        Singularity command: 

        .. parsed-literal:: 
            $ singularity -proc_dwi 
    
        Options:

        - ``-dwi_main <path>``: Provide path to DWI scans with N number of directions and b0. This will override the default settings (default = <bids>/<subject>/dwi/<sub>_<ses>_acq-b<val>_dir-<ndir>_dwi.nii*)
        - ``-dwi_rpe <path>``: Provide path to b0 DWI scan with reverse phase encoding direction. This will override the default settings (default = <bids>/<subject>/dwi/<sub>_<ses>_acq-PA_dir-<ndir>_dwi.nii*)
        - ``-dwi_processed <path>``: The specified image will be used for further DWI processing, instead of performing pre-processing inside the script. This file must be in .mif (MRtrix image format) with bvecs, bvals, PhaseEncodingDirection and ReadoutTime encoded.

    .. tab:: Outputs

        Directories created or populated by **-proc_dwi**:

        .. parsed-literal:: 

            - <outputDirectory>/micapipe/dwi
            - <outputDirectory>/micapipe/dwi/eddy
            - <outputDirectory>/micapipe/xfms

        Files generated by **-proc_dwi**:

        .. parsed-literal:: 
            - DWI pre-processing outputs stored in *<outputDirectory>/micapipe/dwi*. All outputs are in DWI space:
                - DWI residuals from denoising: *<sub>_<ses>_space-dwi_desc-MP-PCA_residuals-dwi.mif*
                - Bias-field corrected DWI: *<sub>_<ses>_space-dwi_desc-MP-PCA_N4_dwi.mif*
                - b0 image used for T1w linear registration to DWI space: *<sub>_<ses>_space-dwi_desc-b0.nii.gz*
                - Subject's T1w image, linear registration to DWI space: *<sub>_<ses>_space-dwi_desc-t1w_nativepro.nii.gz*
                - DWI brain mask, created from MNI152 mask: *<sub>_<ses>_space-dwi_desc-brain_mask.nii.gz*
                - Subject's T1w brain mask, linear registration to DWI space: *<sub>_<ses>_space-dwi_desc-t1w_nativepro-brain.nii.gz*
                - Subject's T1w image, non-linear registration to DWI space: *<sub>_<ses>_space-dwi_desc-t1w_nativepro_NL.nii.gz*
                - 5-tissue-types segmentation, non-linear registration to DWI space: *<sub>_<ses>_space-dwi_desc-5tt.nii.gz*
                - Diffusion tensor estimation image: *<sub>_<ses>_space-dwi_model-DTI.mif*
                - Fractional anisotropy of the diffusion tensor: *<sub>_<ses>_space-dwi_model-DTI_map-FA.mif*
                - Mean apparent diffusion coefficient (mean diffusivity) of the diffusion tensor: *<sub>_<ses>_space-dwi_model-DTI_map-ADC.mif*
                - Normalized fibre orientation distribution for CSF, gray and white matter:
                - Gray/White matter interface mask: *<sub>_<ses>_space-dwi_desc-gmwmi-mask.mif*
                - Track density image generated with 1 million streamlines, for quality check: *<sub>_<ses>_space-dwi_desc-iFOD1-1M_tdi.mif*
            - All outputs from FSL eddy are stored in *<outputDirectory>/micapipe/dwi/eddy*
                

    .. tab:: -slim        

        Files conserved during **-proc_dwi** slim run

        .. parsed-literal:: 
            - ...
                    

-SC
--------------------------------------------------------

This modules computes tractography-based structural connectivity matrices and associated edge length matrices. We apply iFOD2 for this purpose, a probabilistic tractography algortihm.

.. admonition:: Prerequisites üñêüèº

    You need to run **proc_structural**, **proc_freesurfer**, **post_structural**, and **-proc_dwi** before this stage

.. tabs::

    .. tab:: Processing steps
    
        - Compute tractogram with specified number of streamlines using iFOD2 algorithm
        - Build structural connectomes and edge length matrices from cortical, subcortical, and cerebellar parcellations non-linearly registered to DWI space
        - If requested, compute automatic bundle segmentation using `auto tractography <https://github.com/lconcha/auto_tracto>`_.

    .. tab:: Usage

        .. parsed-literal:: 
            $ mica-pipe **-sub** <subject_id> **-out** <outputDirectory> **-bids** <BIDS-directory> **-SC**

        Docker command:

        .. parsed-literal:: 
            $ docker -SC

        Singularity command: 

        .. parsed-literal:: 
            $ singularity -SC
    
        Options:

        - ``-tracts <numeric>``: Number of streamlines used when computing the tractogram (default=40M, where 'M' stands for millions)
        - ``-keep_tck``: If specified, the tractogram will be copied to *<outputDirectory>/micapipe/dwi/
        - ``-autoTract``: Perform automatic bundle segmentation (optional)

    .. tab:: Outputs

        Directories created or populated by **-SC**:

        .. parsed-literal:: 

            - <outputDirectory>/micapipe/dwi
            - <outputDirectory>/micapipe/dwi/connectomes

        Files generated by **-SC**:

        .. parsed-literal:: 
            - SC processing outputs stored in *<outputDirectory>/micapipe/dwi*:
                - Track density image generated with specified number of streamlines: *<sub>_<ses>_space-dwi_desc-iFOD1-<num>_tdi.mif*
                - Subcortical segmentation in DWI space: *<sub>_<ses>_space-dwi_atlas-subcortical.nii.gz*
                - Cerebellar parcellation in DWI space: *<sub>_<ses>_space-dwi_atlas-cerebellum.nii.gz*
            - Connectome and edge length outputs are stored in *<outputDirectory>/micapipe/dwi/connectomes*:
                - <sub>_<ses>_space-dwi_<atlas>_desc-iFOD2-<num>-SIFT2_<nodes>-connectome.txt
                - <sub>_<ses>_space-dwi_atlas-<parc>_desc-iFOD2-<num>-SIFT2_<nodes>-edgeLengths.txt
            
            Note on structural connectomes: <nodes> can be either...
                - *cor*: Only cortical nodes are represented in the connectomes/edge length matrix
                - *sub*: Subcortical and cortical nodes are represented in the the connectomes/edge length matrix
                - *full*: Subcortical, cerebellar, and cortical nodes are represented in the the connectomes/edge length matrix             

    .. tab:: -slim

        Files conserved during **-SC** slim run

        .. parsed-literal:: 
            - ...
