.. _restingstateproc:

.. title:: rs-fMRI

Resting-state fMRI processing
============================================================

This module performs all pre-processing of subject resting-state functional MRI (rsfMRI) scans, in preparation for the construction of functional connectomes. This pipeline is optimized to leverage spin-echo images with reverse phase encoding for distorsion correction. For increased functionality, our pipeline can also handle protocols in which a single fieldmap is acquired.


-proc_rsfmri
--------------------------------------------------------

.. admonition:: Prerequisites üñêüèº

     You need to run **proc_structural**, **proc_freesurfer**, and **post_structural** before this stage

.. tabs::

    .. tab:: Processing steps
    
            - Remove first five TRs and reorient to LPI
            - Perform motion correction within rsfMRI scan and provided fieldmaps by registering each volume to the scan's own average
            - Calculate motion outliers
            - Apply distorsion correction on motion-corrected images
            - High-pass filtering of rsfMRI timeseries to remove frequencies below 0.01Hz
            - Run Multivariate Exploratory Linear Optimized Decomposition into Independent Components (MELODIC) on filtered timeseries
            - Compute linear and non-linear registrations between fMRI and T1-nativepro space, as well as boundary-based registration between fMRI and native Freesurfer space
            - Run FMRIB's ICA-based Xnoiseifier (ICA-FIX) using specified training file. Note that if ICA-FIX is not found on the user's system, or if MELODIC failed, ICA-FIX will be skipped and further processing will be performed using high-pass filtered timeseries
            - Calculate global and tissue-specific signal from processed timeseries (can be used for global-signal regression)
            - Compute motion confounds matrix from processed timeseries, to remove effects of frames with large motion in the timeseries
            - Register processed timeseries to native cortical surface. Minimially pre-processed (i.e. motion and distorsion corrected) timeseries are also registered to the native cortical surface to compute statistics such as temporal signal-to-noise 
            - Surface-template registration of native surface timeseries (fsaverage5, conte69)
            - Native surface, fsaverage5, and conte69-mapped timeseries are each smoothed with a 10mm Gaussian kernel
            - Use previously computed registrations to align cerebellar and subcortical parcellation to fMRI space
            - Regress motion spikes from cerebellar, subcortical, and cortical timeseries in linear model
            - Concatenate cerebellar, subcortical, and parcellated cortical timeseries and compute correlation matrix

    .. tab:: Usage

        .. parsed-literal:: 
            $ mica-pipe **-sub** <subject_id> **-out** <outputDirectory> **-bids** <BIDS-directory> **-proc_rsfmri**

        Docker command:

        .. parsed-literal:: 
            $ docker -proc_rsfmri

        Singularity command: 

        .. parsed-literal:: 
            $ singularity -proc_rsfmri

        Options:

        - ``-topupConfig <path>``: Specify path to config file that should be used for distorsion correction using topup (Default = ``{FSLDIR}/etc/flirtsch/b02b0_1.cnf``)
        - ``-icafixTraining <path>``: Path to specified ICA-FIX training file for nuisance signal regression (file.RData; Default = $MICAPIPE/functions/MICAMTL_training_15HC_15PX.RData)
        - ``-mainScanRun <numeric>``: If multiple resting-state runs exist in the BIDS directory, you must specify which scan to process using this flag
        - ``-phaseReversalRun <numeric>``: If multiple phase encoding runs exist in the BIDS directory (only main phase is checked), you must specify which file to process using this flag
    
    .. tab:: Outputs

        Directories created or populated by **-proc_rsfmri**:

        .. parsed-literal:: 

            - <outputDirectory>/micapipe/func
            - <outputDirectory>/micapipe/func/ICA_MELODIC
            - <outputDirectory>/micapipe/func/surfaces
            - <outputDirectory>/micapipe/func/volumetric
            - <outputDirectory>/micapipe/xfms

        Files generated by **-proc_rsfmri**:

        .. parsed-literal:: 
            - All outputs generated by MELODIC, or necessary for ICA-FiX, are stored in *<<outputDirectory>/micapipe/func/ICA_MELODIC*
            - All volumetric processing outputs are stored in *<outputDirectory>/micapipe/func/volumetric*:
                - Motion confounds processing: *<sub>_*.1D*
                - Motion and distorsion corrected image: *<sub>_singleecho_fmrispace.nii.gz*
                - Timestamp of completed distorsion correction: *TOPUP.txt*
                - Mean motion and distorsion corrected image: *<sub>_singleecho_fmrispace_mean.nii.gz*
                - Skull-stipped mean motion and distorsion corrected image: *<sub>_singleecho_fmrispace_brain.nii.gz*
                - High-passed, motion and distorsion corrected image: *<sub>_singleecho_fmrispace_HP.nii.gz*
                - Nuisance-signal regressed timeseries (i.e. output of ICA-FIX): *<sub>_singleecho_fmrispace_clean.nii.gz*
                - Tissue-specific mean signal (<tissue> = CSF, GM, or WM): *<sub>_singleecho_<tissue>.txt* 
                - Global mean signal: *<sub>_singleecho_global.txt*
                - Subcortical segmentation in fMRI space: *<sub>_singleecho_fmrispace_subcortical.nii.gz*
                - Mean signal in each subcortical parcel: *<sub>_singleecho_timeseries_subcortical.txt*
                - Cerebellar segmentation in fMRI space: *<sub>_singleecho_fmrispace_cerebellum.nii.gz*
                - Mean signal in each cerebellar parcel: *<sub>_singleecho_timeseries_cerebellum.txt*
                - Parcel statistics for cerebellum, to screen for any missing parcels: *<sub>_singleecho_fmrispace_cerebellum_roi_stats.txt*
            - Vertexwise cortical timeseries are stored in *<outputDirectory>/micapipe/func/surfaces*:
                - Motion and distorsion corrected timeseries mapped to native cortical surface: *<sub>_singleecho_fmri2fs_<hemi>_NoHP.mgh*
                - Fully pre-processed timeseries mapped to native cortical surface: *<sub>_singleecho_fmri2fs_<hemi>.mgh* and *<sub>_singleecho_fmri2fs_<hemi>_<smoothing>.mgh*
                - Timeseries mapped to fsaverage5 template: *<sub>_singleecho_fmri2fs_<hemi>_fsa5.mgh* and *<sub>_singleecho_fmri2fs_<hemi>_fsa5_<smoothing>.mgh*
                - Timeseries mapped to conte69 template: *<sub>_singleecho_fmri2fs_<hemi>_c69-32k.mgh* and *<sub>_singleecho_fmri2fs_<hemi>_c69-32k_<smoothing>.mgh*
                - Vertexwise and smoothed timeseries on conte69 template, following regression of motion spikes: *<sub>_rsfMRI-timeseries_conte69_clean.txt*
            - Temporal signal-to-noise ratio computed on native cortical surface from motion and distorsion correction timesries: *<sub>_tSNR.txt*
            - Functional connectome matrices (r values) generated from smoothed, parcellated timeseries sampled in subcortex, cerebellum, and conte69 cortical surface: *<sub>_rsfMRI-connectome_<parc>_conte69_clean.txt*
            - Functional connectome matrices (r values) generated from smoothed, parcellated timeseries sampled in subcortex, cerebellum, and native cortical surface: *<sub>_rsfMRI-connectome_<parc>_clean.txt*
            - Contatenated timeseries sampled in subcortex, cerebellum, and parcellated native cortical surface models: *<sub>_rsfMRI-timeseries_<parc>_clean.txt*

    .. tab:: -slim    

        Files conserved during **-proc_rsfmri** slim run

        .. parsed-literal:: 
            - ...
